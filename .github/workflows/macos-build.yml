name: macOS Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies (SDL2, etc.)
        run: |
          brew update
          brew install cmake pkg-config sdl2 sdl2_image sdl2_ttf

      - name: Configure (CMake)
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=$(uname -m)

      - name: Build
        run: |
          cmake --build build --config Release --parallel

      - name: Package runtime files
        run: |
          set -e
          mkdir -p dist/macos
          # Copy the built binary
          if [ -f "build/zeta" ]; then
            cp build/zeta dist/macos/
          else
            BIN_PATH=$(find build -type f -name zeta | head -n 1)
            cp "$BIN_PATH" dist/macos/
          fi
          chmod +x dist/macos/zeta
          # Bundle game content
          cp -R data dist/macos/data
          cp -R assets dist/macos/assets

      - name: Upload packaged artifact
        uses: actions/upload-artifact@v4
        with:
          name: macOS-runtime
          path: dist/macos
