name: Cross-Platform Builds

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake pkg-config libsdl2-dev libsdl2-image-dev libsdl2-ttf-dev

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew update
          brew install cmake pkg-config sdl2 sdl2_image sdl2_ttf

      - name: Install dependencies (Windows via vcpkg)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          if (-not $env:VCPKG_ROOT) { $env:VCPKG_ROOT = "C:\vcpkg" }
          if (-not (Test-Path $env:VCPKG_ROOT)) {
            git clone https://github.com/microsoft/vcpkg $env:VCPKG_ROOT
          }
          & "$env:VCPKG_ROOT\bootstrap-vcpkg.bat" -disableMetrics
          $triplet = "x64-windows"
          & "$env:VCPKG_ROOT\vcpkg.exe" install sdl2 sdl2-image sdl2-ttf --triplet $triplet
          "VCPKG_ROOT=$env:VCPKG_ROOT" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Configure (CMake on Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          cmake -S . -B build `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" `
            -DVCPKG_TARGET_TRIPLET=x64-windows `
            -A x64

      - name: Configure (CMake on Unix)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: cmake --build build --config Release --parallel

      - name: Build (Unix)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: cmake --build build --config Release --parallel

      - name: Package artifact (Linux/macOS)
        if: matrix.os != 'windows-latest'
        run: |
          set -e
          OUT_DIR="dist/${{ matrix.os }}"
          mkdir -p "$OUT_DIR"
          # Copy the built binary ("Project Aurora Zeta")
          BIN_PATH=$(find build -maxdepth 3 -type f \( -name "Project Aurora Zeta" -o -name "Project Aurora Zeta.exe" \) | head -n 1)
          if [[ -z "$BIN_PATH" ]]; then
            echo "Built binary not found" >&2
            exit 1
          fi
          cp "$BIN_PATH" "$OUT_DIR/"
          chmod +x "$OUT_DIR/$(basename "$BIN_PATH")"
          # Bundle game content
          cp -R data "$OUT_DIR/data"
          cp -R assets "$OUT_DIR/assets"
        shell: bash

      - name: Package artifact (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $OutDir = "dist/windows-latest"
          New-Item -ItemType Directory -Force -Path $OutDir | Out-Null

          $bin = Get-ChildItem -Recurse -File -Filter "Project Aurora Zeta.exe" -Path build | Select-Object -First 1
          if (-not $bin) { throw "Built binary not found" }
          Copy-Item $bin.FullName "$OutDir/Project Aurora Zeta.exe"

          # Copy required SDL runtime DLLs from vcpkg
          $dllSource = Join-Path $env:VCPKG_ROOT "installed/x64-windows/bin"
          Copy-Item "$dllSource/*.dll" $OutDir -Force

          Copy-Item data $OutDir/data -Recurse
          Copy-Item assets $OutDir/assets -Recurse

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: project-aurora-zeta-${{ matrix.os }}
          path: |
            dist/${{ matrix.os }}
          if-no-files-found: error

  android:
    name: Build (Android)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect Android Gradle wrapper
        id: detect-android
        run: |
          FOUND="false"
          WRAPPER=""
          WORKDIR=""

          if [ -f ./gradlew ]; then
            FOUND="true"
            WRAPPER="gradlew"
            WORKDIR="."
            echo "Using root-level Gradle wrapper"
          elif [ -f ./android/gradlew ]; then
            FOUND="true"
            WRAPPER="gradlew"
            WORKDIR="android"
            echo "Using Gradle wrapper from android/"
          else
            echo "Android Gradle wrapper not found. Add an Android project with Gradle wrapper (see docs/AndroidBuild.md). Skipping Android build." >&2
          fi

          {
            echo "found=${FOUND}"
            echo "wrapper=${WRAPPER}"
            echo "workdir=${WORKDIR}"
          } >> "$GITHUB_OUTPUT"

          echo "ANDROID_FOUND=${FOUND}" >> "$GITHUB_ENV"

      - name: Require Android wrapper when detected
        if: env.ANDROID_FOUND == 'true'
        run: |
          echo "Android Gradle wrapper detected; continuing with SDK and build setup."

      - name: Set up JDK
        if: env.ANDROID_FOUND == 'true'
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Android SDK
        if: env.ANDROID_FOUND == 'true'
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          ndk: 26.1.10909125
          cmake: 3.22.1
          components: |-
            build-tools;34.0.0
            platforms;android-34
            platform-tools

      - name: Install Android build essentials (Linux)
        if: env.ANDROID_FOUND == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build

      - name: Cache Gradle
        if: env.ANDROID_FOUND == 'true'
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Build debug APK
        if: env.ANDROID_FOUND == 'true'
        env:
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
        working-directory: ${{ steps.detect-android.outputs.workdir }}
        shell: bash
        run: |
          set -euo pipefail
          WRAPPER="${{ steps.detect-android.outputs.wrapper }}"

          if [ -z "$WRAPPER" ]; then
            echo "Android Gradle wrapper not detected" >&2
            exit 1
          fi

          chmod +x "$WRAPPER"
          "./$WRAPPER" --no-daemon assembleDebug

      - name: Locate built APKs
        if: env.ANDROID_FOUND == 'true'
        id: locate-apk
        shell: bash
        run: |
          set -euo pipefail

          WORKDIR="${{ steps.detect-android.outputs.workdir }}"
          APK_LIST=$(find "$WORKDIR" -type f -path "*/build/outputs/apk/*/*.apk" | sort)

          if [ -z "$APK_LIST" ]; then
            echo "No APK artifacts found after assembleDebug." >&2
            exit 1
          fi

          printf "paths<<'EOF'\n%s\nEOF\n" "$APK_LIST" >> "$GITHUB_OUTPUT"

      - name: Upload Android artifact
        if: env.ANDROID_FOUND == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: project-aurora-zeta-android
          path: ${{ steps.locate-apk.outputs.paths }}
          if-no-files-found: error
