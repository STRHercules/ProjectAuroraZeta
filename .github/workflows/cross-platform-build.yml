name: Cross-Platform Builds

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake pkg-config libsdl2-dev libsdl2-image-dev libsdl2-ttf-dev libsdl2-mixer-dev

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew update
          brew install cmake pkg-config sdl2 sdl2_image sdl2_ttf sdl2_mixer

      - name: Install dependencies (Windows via vcpkg)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          if (-not $env:VCPKG_ROOT) { $env:VCPKG_ROOT = "C:\vcpkg" }
          if (-not (Test-Path $env:VCPKG_ROOT)) {
            git clone https://github.com/microsoft/vcpkg $env:VCPKG_ROOT
          }
          & "$env:VCPKG_ROOT\bootstrap-vcpkg.bat" -disableMetrics
          $triplet = "x64-windows"
          & "$env:VCPKG_ROOT\vcpkg.exe" install sdl2 sdl2-image sdl2-ttf sdl2-mixer --triplet $triplet
          "VCPKG_ROOT=$env:VCPKG_ROOT" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Configure (CMake on Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          cmake -S . -B build `
            -DCMAKE_BUILD_TYPE=Release `
            -DZETA_REQUIRE_AUDIO=ON `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" `
            -DVCPKG_TARGET_TRIPLET=x64-windows `
            -A x64

      - name: Configure (CMake on Unix)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DZETA_REQUIRE_AUDIO=ON

      - name: Build (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: cmake --build build --config Release --parallel

      - name: Build (Unix)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: cmake --build build --config Release --parallel

      - name: Verify audio linkage (Linux)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          set -euo pipefail
          BIN_PATH=$(find build -maxdepth 3 -type f -name "Project Aurora Zeta" | head -n 1)
          if [[ -z "$BIN_PATH" ]]; then
            echo "Built binary not found" >&2
            exit 1
          fi
          ldd "$BIN_PATH" | grep -i "sdl2_mixer" >/dev/null

      - name: Verify audio linkage (macOS)
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          set -euo pipefail
          BIN_PATH=$(find build -maxdepth 3 -type f -name "Project Aurora Zeta" | head -n 1)
          if [[ -z "$BIN_PATH" ]]; then
            echo "Built binary not found" >&2
            exit 1
          fi
          otool -L "$BIN_PATH" | grep -i "SDL2_mixer" >/dev/null

      - name: Package artifact (Linux/macOS)
        if: matrix.os != 'windows-latest'
        run: |
          set -e
          OUT_DIR="dist/${{ matrix.os }}"
          mkdir -p "$OUT_DIR"
          # Copy the built binary ("Project Aurora Zeta")
          BIN_PATH=$(find build -maxdepth 3 -type f \( -name "Project Aurora Zeta" -o -name "Project Aurora Zeta.exe" \) | head -n 1)
          if [[ -z "$BIN_PATH" ]]; then
            echo "Built binary not found" >&2
            exit 1
          fi
          cp "$BIN_PATH" "$OUT_DIR/"
          chmod +x "$OUT_DIR/$(basename "$BIN_PATH")"
          # Bundle game content
          cp -R data "$OUT_DIR/data"
          cp -R assets "$OUT_DIR/assets"
        shell: bash

      - name: Package artifact (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $OutDir = "dist/windows-latest"
          New-Item -ItemType Directory -Force -Path $OutDir | Out-Null

          $bin = Get-ChildItem -Recurse -File -Filter "Project Aurora Zeta.exe" -Path build | Select-Object -First 1
          if (-not $bin) { throw "Built binary not found" }
          Copy-Item $bin.FullName "$OutDir/Project Aurora Zeta.exe"

          # Copy required SDL runtime DLLs from vcpkg
          $dllSource = Join-Path $env:VCPKG_ROOT "installed/x64-windows/bin"
          Copy-Item "$dllSource/*.dll" $OutDir -Force
          if (-not (Test-Path (Join-Path $OutDir "SDL2_mixer.dll"))) { throw "SDL2_mixer.dll missing from packaged artifact" }

          Copy-Item data $OutDir/data -Recurse
          Copy-Item assets $OutDir/assets -Recurse

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: project-aurora-zeta-${{ matrix.os }}
          path: |
            dist/${{ matrix.os }}
          if-no-files-found: error
