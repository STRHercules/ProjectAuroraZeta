name: Cross-Platform Builds

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake pkg-config libsdl2-dev libsdl2-image-dev libsdl2-ttf-dev

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew update
          brew install cmake pkg-config sdl2 sdl2_image sdl2_ttf

      - name: Install dependencies (Windows via vcpkg)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          if (-not $env:VCPKG_ROOT) { $env:VCPKG_ROOT = "C:\vcpkg" }
          if (-not (Test-Path $env:VCPKG_ROOT)) {
            git clone https://github.com/microsoft/vcpkg $env:VCPKG_ROOT
          }
          & "$env:VCPKG_ROOT\bootstrap-vcpkg.bat" -disableMetrics
          $triplet = "x64-windows"
          & "$env:VCPKG_ROOT\vcpkg.exe" install sdl2 sdl2-image sdl2-ttf --triplet $triplet
          "VCPKG_ROOT=$env:VCPKG_ROOT" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Configure (CMake on Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          cmake -S . -B build `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" `
            -DVCPKG_TARGET_TRIPLET=x64-windows `
            -A x64

      - name: Configure (CMake on Unix)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: cmake --build build --config Release --parallel

      - name: Build (Unix)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: cmake --build build --config Release --parallel

      - name: Package artifact (Linux/macOS)
        if: matrix.os != 'windows-latest'
        run: |
          set -e
          OUT_DIR="dist/${{ matrix.os }}"
          mkdir -p "$OUT_DIR"
          # Copy the built binary ("Project Aurora Zeta")
          BIN_PATH=$(find build -maxdepth 3 -type f \( -name "Project Aurora Zeta" -o -name "Project Aurora Zeta.exe" \) | head -n 1)
          if [[ -z "$BIN_PATH" ]]; then
            echo "Built binary not found" >&2
            exit 1
          fi
          cp "$BIN_PATH" "$OUT_DIR/"
          chmod +x "$OUT_DIR/$(basename "$BIN_PATH")"
          # Bundle game content
          cp -R data "$OUT_DIR/data"
          cp -R assets "$OUT_DIR/assets"
        shell: bash

      - name: Package artifact (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $OutDir = "dist/windows-latest"
          New-Item -ItemType Directory -Force -Path $OutDir | Out-Null

          $bin = Get-ChildItem -Recurse -File -Filter "Project Aurora Zeta.exe" -Path build | Select-Object -First 1
          if (-not $bin) { throw "Built binary not found" }
          Copy-Item $bin.FullName "$OutDir/Project Aurora Zeta.exe"

          # Copy required SDL runtime DLLs from vcpkg
          $dllSource = Join-Path $env:VCPKG_ROOT "installed/x64-windows/bin"
          Copy-Item "$dllSource/*.dll" $OutDir -Force

          Copy-Item data $OutDir/data -Recurse
          Copy-Item assets $OutDir/assets -Recurse

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: project-aurora-zeta-${{ matrix.os }}
          path: |
            dist/${{ matrix.os }}
          if-no-files-found: error

  android:
    name: Build (Android)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure Android project is present
        run: |
          if [ -x ./gradlew ]; then
            echo "Using root-level Gradle wrapper"
            exit 0
          fi

          if [ -x ./android/gradlew ]; then
            echo "Using Gradle wrapper from android/"
            exit 0
          fi

          echo "Android Gradle wrapper not found. Add an Android project with Gradle wrapper (see docs/AndroidBuild.md)." >&2
          exit 1

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          ndk: 26.1.10909125
          cmake: 3.22.1
          components: |-
            build-tools;34.0.0
            platform-tools

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Build debug APK
        env:
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
        run: |
          set -e
          if [ -x ./gradlew ]; then
            WRAPPER=./gradlew
            WORKDIR=.
          else
            WRAPPER=./android/gradlew
            WORKDIR=android
          fi

          cd "$WORKDIR"
          "$WRAPPER" --no-daemon assembleDebug

      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: project-aurora-zeta-android
          path: |
            android/app/build/outputs/apk/debug/*.apk
            app/build/outputs/apk/debug/*.apk
          if-no-files-found: error
